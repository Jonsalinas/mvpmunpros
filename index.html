<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Munpros - Transcriptor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-section:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        .upload-section.dragging {
            background: #e8eeff;
            border-color: #667eea;
        }

        input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 60px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }

        .file-info {
            color: #666;
            font-size: 14px;
            margin-top: 15px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        select, button {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 16px;
            transition: all 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-transcribe {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            padding: 15px 30px;
            margin-top: 20px;
        }

        .btn-transcribe:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-transcribe:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            margin: 30px 0;
        }

        .progress-section.active {
            display: block;
        }

        .step {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: #f5f5f5;
            transition: all 0.3s;
        }

        .step.active {
            background: #e8eeff;
            border-left: 4px solid #667eea;
        }

        .step.completed {
            background: #e8ffe8;
            border-left: 4px solid #4caf50;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .step.active .step-icon {
            background: #667eea;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .step.completed .step-icon {
            background: #4caf50;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .results-section.active {
            display: block;
        }

        .text-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .text-comparison {
                grid-template-columns: 1fr;
            }
        }

        .text-box {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #ddd;
        }

        .text-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .text-box.improved h3 {
            color: #4caf50;
        }

        .text-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            color: #333;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-download {
            padding: 12px 24px;
            border-radius: 8px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-download:hover {
            background: #667eea;
            color: white;
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è Transcriptor Inteligente</h1>
        <p class="subtitle">Sube tu audio y obt√©n una transcripci√≥n mejorada con IA</p>

        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Arrastra tu archivo de audio aqu√≠ o haz clic para seleccionar</div>
            <div class="file-info">Formatos soportados: MP3, WAV, M4A, OGG</div>
            <input type="file" id="audioFile" accept="audio/*">
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="modelo">Modelo Whisper</label>
                <select id="modelo">
                    <option value="tiny">Tiny (R√°pido)</option>
                    <option value="base" selected>Base (Balanceado)</option>
                    <option value="small">Small (Preciso)</option>
                    <option value="medium">Medium (Muy preciso)</option>
                    <option value="large">Large (M√°xima precisi√≥n)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="idioma">Idioma</label>
                <select id="idioma">
                    <option value="es" selected>Espa√±ol</option>
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="de">Deutsch</option>
                    <option value="">Auto-detectar</option>
                </select>
            </div>

            <div class="control-group">
                <label for="mejorar">Mejorar con IA</label>
                <select id="mejorar">
                    <option value="true" selected>S√≠ (Recomendado)</option>
                    <option value="false">No</option>
                </select>
            </div>
        </div>

        <button class="btn-transcribe" id="btnTranscribe" disabled>
            Selecciona un archivo primero
        </button>

        <div class="progress-section" id="progressSection">
            <div class="step" id="stepUpload">
                <div class="step-icon">üì§</div>
                <div>
                    <strong>Subiendo archivo</strong>
                    <div class="step-message">Esperando...</div>
                </div>
            </div>

            <div class="step" id="stepLoading">
                <div class="step-icon">‚öôÔ∏è</div>
                <div>
                    <strong>Cargando modelo</strong>
                    <div class="step-message">Esperando...</div>
                </div>
            </div>

            <div class="step" id="stepTranscribing">
                <div class="step-icon">üé§</div>
                <div>
                    <strong>Transcribiendo audio</strong>
                    <div class="step-message">Esperando...</div>
                </div>
            </div>

            <div class="step" id="stepImproving">
                <div class="step-icon">‚ú®</div>
                <div>
                    <strong>Mejorando con IA</strong>
                    <div class="step-message">Esperando...</div>
                </div>
            </div>

            <div class="step" id="stepCompleted">
                <div class="step-icon">‚úÖ</div>
                <div>
                    <strong>¬°Completado!</strong>
                    <div class="step-message">Esperando...</div>
                </div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <h2 style="margin-bottom: 20px; color: #333;">üìä Resultados</h2>
            
            <div class="text-comparison">
                <div class="text-box">
                    <h3>üìù Texto Original (Whisper)</h3>
                    <div class="text-content" id="textOriginal">
                        Aqu√≠ aparecer√° el texto transcrito...
                    </div>
                </div>

                <div class="text-box improved">
                    <h3>‚ú® Texto Mejorado (IA)</h3>
                    <div class="text-content" id="textImproved">
                        Aqu√≠ aparecer√° el texto mejorado...
                    </div>
                </div>
            </div>

            <div class="download-buttons">
                <button class="btn-download" onclick="descargarTexto('txt')">üìÑ Descargar TXT</button>
                <button class="btn-download" onclick="descargarTexto('docx')">üìò Descargar DOCX</button>
                <button class="btn-download" onclick="descargarTexto('pdf')">üìï Descargar PDF</button>
            </div>
        </div>
    </div>

    <script>
        const uploadSection = document.getElementById('uploadSection');
        const audioFile = document.getElementById('audioFile');
        const btnTranscribe = document.getElementById('btnTranscribe');
        const progressSection = document.getElementById('progressSection');
        const resultsSection = document.getElementById('resultsSection');

        let archivoSeleccionado = null;
        const API_URL = 'http://localhost:8000'; // Cambiar por tu URL

        // Click para abrir selector de archivos
        uploadSection.addEventListener('click', (e) => {

            audioFile.click();
        });
        
        // Drag & Drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadSection.classList.add('dragging');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragging');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragging');
            if (e.dataTransfer.files.length) {
                audioFile.files = e.dataTransfer.files;
                manejarArchivoSeleccionado();
            }
        });

        audioFile.addEventListener('change', manejarArchivoSeleccionado);

        function manejarArchivoSeleccionado() {
            const file = audioFile.files[0];
            if (file) {
                archivoSeleccionado = file;
                const fileInfo = uploadSection.querySelector('.file-info');
                fileInfo.textContent = `‚úÖ Archivo: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                fileInfo.style.color = '#4caf50';
                fileInfo.style.fontWeight = 'bold';
                
                btnTranscribe.disabled = false;
                btnTranscribe.textContent = 'üöÄ Comenzar Transcripci√≥n';
            }
        }

        btnTranscribe.addEventListener('click', iniciarTranscripcion);

        async function iniciarTranscripcion() {
            if (!archivoSeleccionado) return;

            btnTranscribe.disabled = true;
            btnTranscribe.innerHTML = '<span class="loader"></span> Procesando...';
            progressSection.classList.add('active');
            resultsSection.classList.remove('active');

            // Resetear pasos
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });

            const formData = new FormData();
            formData.append('file', archivoSeleccionado);
            formData.append('language', document.getElementById('idioma').value);
            formData.append('modelo', document.getElementById('modelo').value);
            formData.append('mejorar', document.getElementById('mejorar').value);

            try {
                const response = await fetch(`${API_URL}/transcribe-stream`, {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            manejarEvento(data);
                        }
                    }
                }

            } catch (error) {
                alert('Error al transcribir: ' + error.message);
                console.error(error);
            } finally {
                btnTranscribe.disabled = false;
                btnTranscribe.textContent = 'üöÄ Comenzar Transcripci√≥n';
            }
        }

        function manejarEvento(data) {
            const { step, message, text, text_improved, language } = data;

            // Actualizar pasos visuales
            switch(step) {
                case 'upload':
                    activarPaso('stepUpload', message);
                    break;
                
                case 'loading':
                    completarPaso('stepUpload');
                    activarPaso('stepLoading', message);
                    break;
                
                case 'transcribing':
                    completarPaso('stepLoading');
                    activarPaso('stepTranscribing', message);
                    break;
                
                case 'transcribed':
                    completarPaso('stepTranscribing');
                    document.getElementById('textOriginal').textContent = text;
                    break;
                
                case 'improving':
                    activarPaso('stepImproving', message);
                    break;
                
                case 'completed':
                    completarPaso('stepImproving');
                    activarPaso('stepCompleted', message);
                    completarPaso('stepCompleted');
                    
                    if (text_improved) {
                        document.getElementById('textImproved').textContent = text_improved;
                    } else {
                        document.getElementById('textImproved').textContent = 'No se aplic√≥ mejora con IA';
                    }
                    
                    resultsSection.classList.add('active');
                    break;
                
                case 'error':
                    alert('Error: ' + message);
                    break;
            }
        }

        function activarPaso(stepId, message) {
            const step = document.getElementById(stepId);
            step.classList.add('active');
            step.querySelector('.step-message').textContent = message;
        }

        function completarPaso(stepId) {
            const step = document.getElementById(stepId);
            step.classList.remove('active');
            step.classList.add('completed');
        }

        async function descargarTexto(formato) {
            if (!archivoSeleccionado) return;

            const formData = new FormData();
            formData.append('file', archivoSeleccionado);
            formData.append('language', document.getElementById('idioma').value);
            formData.append('modelo', document.getElementById('modelo').value);
            formData.append('formato', formato);
            formData.append('mejorar', document.getElementById('mejorar').value);

            try {
                const response = await fetch(`${API_URL}/transcribe`, {
                    method: 'POST',
                    body: formData
                });

                if (formato === 'json') {
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    descargarBlob(blob, 'transcripcion.json');
                } else {
                    const blob = await response.blob();
                    descargarBlob(blob, `transcripcion.${formato}`);
                }
            } catch (error) {
                alert('Error al descargar: ' + error.message);
            }
        }

        function descargarBlob(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
